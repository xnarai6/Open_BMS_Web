<!DOCTYPE html>
<html>
    <head>
        <%- include('../../layout/meta.ejs') %>
        <%- include('../../layout/title.ejs') %>
        <%- include('../../layout/css.ejs') %>
    </head>

    <body>
        <div id="layout-wrapper">
            <%- include('../../layout/topbar.ejs') %>
            <%- include('../common/sidebar.ejs') %>
            <div class="main-content">
                <div class="page-content">
                    <div class="container-fluid">
                        <!-- <%- include('../common/topcard.ejs') %> -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box d-flex align-items-center justify-content-between">
                                    <h4 class="mb-0">사용자 관리 - 등록</h4>
                                    <div>
                                        <input type="submit" class="btn btn-primary waves-effect waves-light me-1" id="regBtn" value="등록">
                                        <input type="reset" class="btn btn-secondary waves-effect" id="resetBtn" value="초기화">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <form>
                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <label class="form-label">아이디</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="userId" autocomplete="off">
                                                        <div class="input-group-prepend">
                                                            <input type="button" class="input-group-text" id="userIdChk" value="중복체크">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <label class="form-label">이름</label>
                                                    <input type="text" class="form-control" id="userName" autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">비밀번호</label>
                                                    <input type="password" class="form-control" id="userPw1">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">비밀번호 확인</label>
                                                    <input type="password" class="form-control" id="userPw2">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label">이메일</label>
                                                    <input type="text" class="form-control" id="userEmailId">
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label d-none d-md-block">&nbsp;</label>
                                                    <select class="form-control form-select" id="userEmailSelect">
                                                        <option value="input">직접입력</option>
                                                        <option value="naver.com">naver.com</option>
                                                        <option value="gmail.com">gmail.com</option>
                                                        <option value="hanmail.net">hanmail.net</option>
                                                        <option value="hotmail.com">hotmail.com</option>
                                                        <option value="nate.com">nate.com</option>
                                                        <option value="yahoo.co.kr">yahoo.co.kr</option>
                                                        <option value="empas.com">empas.com</option>
                                                        <option value="dreamwiz.com">dreamwiz.com</option>
                                                        <option value="freechal.com">freechal.com</option>
                                                        <option value="lycos.co.kr">lycos.co.kr</option>
                                                        <option value="korea.com">korea.com</option>
                                                        <option value="hanmir.com">hanmir.com</option>
                                                        <option value="paran.com">paran.com</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label d-none d-md-block">&nbsp;</label>
                                                    <div class="input-group">
                                                        <div class="input-group-prepend"><div class="input-group-text">@</div></div>
                                                        <input type="text" class="form-control" id="userEmailAddr">
                                                    </div>
                                                </div>
                                                <div class="col-md-2 mb-3">
                                                    <label class="form-label d-none d-md-block">알람수신여부</label>
                                                    <div class="form-check form-switch form-switch-lg mb-0">
                                                        <input name="switch" type="checkbox" class="form-check-input" id="userEmailAllow" checked>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label">휴대폰번호</label>
                                                    <select class="form-control form-select" id="userTel1">
                                                        <option value="010">010</option>
                                                        <option value="011">011</option>
                                                        <option value="016">016</option>
                                                        <option value="017">017</option>
                                                        <option value="019">019</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label class="form-label d-none d-md-block">&nbsp;</label>
                                                    <input type="text" class="form-control" id="userTel2">
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <label class="form-label d-none d-md-block">&nbsp;</label>
                                                    <input type="text" class="form-control" id="userTel3">
                                                </div>
                                                <div class="col-md-2 mb-3">
                                                    <label class="form-label d-none d-md-block">알람수신여부</label>
                                                    <div class="form-check form-switch form-switch-lg mb-0">
                                                        <input name="switch" type="checkbox" class="form-check-input" id="userTelAllow" checked>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12 mb-3">
                                                    <label class="form-label">권한</label>
                                                    <select class="form-control form-select" id="userRole"></select>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <%- include('../../layout/footer.ejs') %>
            </div>
        </div>

        <%- include('../../layout/scripts.ejs') %>
        <script>
            let idChk = false;

            $(async function() {
                // 1. code list 가져오기
                let result = await syncAjax('default', 'POST', '/smartpole/manage/user/reg/code', {});

                // 2. 결과 fail 체크
                let resultChk = syncAjaxFailChk(result);
                if (!resultChk) return false;

                let codeMap = result.data.codeMap['role_d'];

                makeRoleSelect(false, $('#userRole'), Object.keys(codeMap).map(e => { return { val: e, name: codeMap[e] } }));
            });

            function makeRoleSelect(all, target, list) {
                $(target).empty();
                if (all) $(target).append('<option value="all">전체</option>');
                for (var el of list) $(target).append('<option value="' + el.val + '">' + el.name + '</option>');
                $(target).change();
            }

            // 등록
            $('#regBtn').on('click', async function(e) {
                e.preventDefault();

                // 0. 중복체크 확인
                if (!idChk) {
                    alert('아이디 중복체크 해주세요');
                    return false;
                }

                // 0. 비밀번호 동일 확인
                if ($('#userPw1').val() != $('#userPw2').val()) {
                    alert('동일한 비밀번호를 입력해주세요');
                    return false;
                }

                // 1. post data 생성
                let postData = {
                    id: $('#userId').val(),
                    name: $('#userName').val(),
                    pw: $('#userPw1').val(),
                    email: $('#userEmailId').val() + '@' + $('#userEmailAddr').val(),
                    tel: $('#userTel1').val() + '-' + $('#userTel2').val() + '-' + $('#userTel3').val(),
                    emailAllow: ($('#userEmailAllow').is(":checked") ? 'Y' : 'N'),
                    telAllow: ($('#userTelAllow').is(":checked") ? 'Y' : 'N'),
                    role: $('#userRole').val()
                }

                // 2. 등록 요청
                let result = await syncAjax('default', 'POST', '/smartpole/manage/user/chk/reg', postData);

                // 3. 결과 fail 체크
                let resultChk = syncAjaxFailChk(result);
                if (!resultChk) return false;

                // 4. 결과 SUCCESS
                alert(result.msg);
                location.replace(result.path);
            });

            // 초기화
            $('#resetBtn').on('click', function(e) {
                e.preventDefault();
                $('form').each(function() { this.reset(); });
                idChk = false;
            });

            // 중복가입 체크
            $('#userIdChk').on('click', async function(e) {
                e.preventDefault();

                // 0. 이미 체크한 경우
                if (idChk) {
                    alert('이미 중복체크한 아이디입니다');
                    return false;
                }

                // 1. post data 생성
                let postData = { id: $('#userId').val() }

                // 2. 중복체크 요청
                let result = await syncAjax('default', 'POST', '/smartpole/manage/user/reg/dup', postData);

                // 3. 결과 fail 체크
                let resultChk = syncAjaxFailChk(result);
                if (!resultChk) {
                    idChk = false;
                    return false;
                }

                // 4. 결과 SUCCESS
                idChk = true;
                alert(result.msg);
            });

            // 사용자 id 변경
            $('#userId').on('change', function() {
                idChk = false;
            });

            // 이메일 select 변경
            $('#userEmailSelect').on('change', function() {
                if($(this).val() == 'input') $('#userEmailAddr').attr('disabled', false).val('');
                else $('#userEmailAddr').attr('disabled', true).val($(this).val());
            });
        </script>
    </body>
</html>